<h2 class="page-title">Todos los vehículos</h2>

<div class="filters-bar">

  <input
    type="text"
    placeholder="Buscar por nombre o modelo..."
    [(ngModel)]="searchText"
  />

  <select   [(ngModel)]="selectedClass">
    <option value="">Todas las clases</option>
    <option *ngFor="let class of classes" [value]="class.id">{{ class.name }}</option>
  </select>

  <select [(ngModel)]="sortOrder">
    <option value="az">Nombre A–Z</option>
    <option value="za">Nombre Z–A</option>
  </select>

</div>


<div *ngIf="loading" class="loader-container">
  <app-loader></app-loader>
</div>

<div class="vehicles-list">
  <div *ngFor="let v of filteredVehicles" class="vehicle-card">
    <div class="img-container">
      <a routerLink="/vehicles/{{v.class_id}}" routerLinkActive="active"><span class="class-badge">
        {{ v.class_id === 1 ? 'B' : v.class_id === 2 ? 'A' : v.class_id === 3 ? 'S+' : 'C' }}
      </span></a>
      <span class="class-copy">
        <i (click)="copyModel(v.model)" class="material-icons" title="Copiar modelo al portapapeles">
          copy_all
        </i>
      </span>
      <img [src]="v.image_url" onerror="this.onerror=null;this.src='https://i.imgur.com/5fXa2iY.png';" alt="{{ v.name }}" />
    </div>
    <div class="vehicle-info">
      <h3>{{ v.name }}</h3>

      <div class="margenes"><span>Seguir en-></span><span>{{ v.follow_class }}</span></div>
      <div class="margenes"><span>Tuneado-></span><span>{{ v.tuned }}</span></div>
      <p>Nota: {{ v.note }}</p>
      <div class="buttons" *ngIf="isAdmin">
        <button class="edit-btn" (click)="startEdit(v)">Editar</button>
        <button class="delete-btn" (click)="deleteVehicle(v.id)">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="editingVehicle" class="edit-form">
  <h3>Editar vehículo</h3>

  <input type="text" [(ngModel)]="editingVehicle.name" placeholder="Nombre" />
  <input type="text" [(ngModel)]="editingVehicle.model" placeholder="Modelo" />
  <input type="text" [(ngModel)]="editingVehicle.image_url" placeholder="URL imagen" />

  <div class="preview" *ngIf="editingVehicle.image_url">
    <img
      [src]="editingVehicle.image_url"
      (load)="onImageLoad()"
      (error)="onImageError()"
    />
    <p *ngIf="editingVehicle.image_url.startsWith('data:')" class="error-msg">
      ❌ No se permiten imágenes en formato data URL
    </p>
    <p *ngIf="!imageOk" class="error-msg">
      ❌ La imagen no carga o el enlace no es válido
    </p>
  </div>
  <p>
    Clase:
    <select name="class_id" id="class_id" [(ngModel)]="editingVehicle.class_id">
      <option *ngFor="let class of classes" [value]="class.id">{{ class.name }}</option>
    </select>
  </p>
  
  <div style="display: flex; align-items: center; gap: 10px;">
  <label for="follow_class" style="white-space: nowrap;">
    Se sigue con:
  </label>

  <input
    type="text"
    id="follow_class"
    name="follow_class"
    [(ngModel)]="editingVehicle.follow_class"
    placeholder="Clase a seguir"
    style="flex: 1;"
  />
  </div>
  <div style="display: flex; align-items: center; gap: 10px;">
  <label for="tuned" style="white-space: nowrap;">
    Tuneado:
  </label>

  <input
    type="text"
    id="tuned"
    name="tuned"
    [(ngModel)]="editingVehicle.tuned"
    placeholder="Tuneado"
    style="flex: 1;"
  />
  </div>
  <input style="height:30px;" type="text" name="note" id="note" [(ngModel)]="editingVehicle.note" placeholder="Nota" />
  <div class="form-buttons">
    <button class="save-btn" (click)="editVehicle()" [disabled]="!imageOk || editingVehicle.image_url.startsWith('data:')">Guardar</button>
    <button class="cancel-btn" (click)="editingVehicle = null">Cancelar</button>
  </div>
</div>